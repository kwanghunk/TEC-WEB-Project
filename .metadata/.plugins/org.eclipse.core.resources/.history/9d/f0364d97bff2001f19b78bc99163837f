package com.tecProject.tec.controller;

import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.tecProject.tec.domain.UserSupport;
import com.tecProject.tec.dto.UserSupportDTO;
import com.tecProject.tec.dto.support.SupportReplyUpdateDTO;
import com.tecProject.tec.dto.support.SupportReplyWriteDTO;
import com.tecProject.tec.dto.support.UserSupportDetailDTO;
import com.tecProject.tec.dto.support.UserSupportSearchDTO;
import com.tecProject.tec.dto.support.UserSupportUpdateDTO;
import com.tecProject.tec.dto.support.UserSupportWriteDTO;
import com.tecProject.tec.service.SupportService;

@RestController
@RequestMapping("/api/user-support")
public class SupportController {

	private final SupportService supportService;
	
    // ì„œë¹„ìŠ¤ ì‚¬ìš© ì¤€ë¹„
    public SupportController(SupportService supportService) {
        this.supportService = supportService;
    }
    
    // ë¬¸ì˜ ë“±ë¡(ì‚¬ìš©ì)
    @PostMapping
    public ResponseEntity<?> createInquiry(@RequestBody UserSupportWriteDTO userSupportWriteDTO) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
        
        // í•„ìˆ˜ ê°’ ê²€ì¦
        if (userSupportWriteDTO.getTitle() == null || userSupportWriteDTO.getTitle().trim().isEmpty()) {
        	return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ë¬¸ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        }
        if (userSupportWriteDTO.getContent() == null || userSupportWriteDTO.getContent().trim().isEmpty()) {
        	return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        }
        if (userSupportWriteDTO.getCategory() == null) {
        	return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
        String username = authentication.getName(); // JWTì—ì„œ username ì¶”ì¶œ
        UserSupportWriteDTO createdInquiry = supportService.createInquiry(userSupportWriteDTO, username);

        return ResponseEntity.ok(createdInquiry);
    }
    
    // ë¬¸ì˜ ìˆ˜ì •(ì‚¬ìš©ì)
    @PutMapping("/{inquiryNo}")
    public ResponseEntity<?> updateInquiry(@PathVariable("inquiryNo") int inquiryNo,
                                            @RequestBody UserSupportDTO updatedInquiry) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
        String username = authentication.getName(); // JWTì—ì„œ username ì¶”ì¶œ
        // ì„œë¹„ìŠ¤ í˜¸ì¶œ
        Optional<UserSupport> inquiry = supportService.updateInquiry(
                inquiryNo,
                username,
                updatedInquiry.getTitle(),
                updatedInquiry.getContent(),
                updatedInquiry.getCategory()
        );
        if (inquiry.isPresent()) {
            return ResponseEntity.ok(UserSupportUpdateDTO.fromEntity(inquiry.get()));
        } else {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body("ë¬¸ì˜ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
    // ë¬¸ì˜ ì‚­ì œ(ì‚¬ìš©ì)
    @DeleteMapping("/{inquiryNo}")
    public ResponseEntity<?> deleteInquiry(@PathVariable("inquiryNo") int inquiryNo) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        String username = authentication.getName(); // JWTì—ì„œ username ì¶”ì¶œ
        Optional<UserSupport> deletedInquiry = supportService.deleteInquiry(inquiryNo, username);

        if (deletedInquiry.isPresent()) {
            return ResponseEntity.ok("ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body("ë¬¸ì˜ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
    // ë¬¸ì˜ë‚´ì—­ ì „ì²´ì¡°íšŒ(ì‚¬ìš©ì)
    @GetMapping
    public ResponseEntity<?> getInquiryByUsername() {
    	Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    	if (authentication == null || !authentication.isAuthenticated()) {
    		return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    	}
    	
    	String username = authentication.getName(); // JWTì—ì„œ username ì¶”ì¶œ
    	List<UserSupportSearchDTO> inquiries = supportService.getInquiryByUsername(username);
    	
    	if (inquiries.isEmpty()) {
    		return ResponseEntity.ok("ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
    	}
    	return ResponseEntity.ok(inquiries);
    }
    
	// ë¬¸ì˜ë‚´ì—­ í‚¤ì›Œë“œ ì¡°íšŒ(ì‚¬ìš©ì)
    @GetMapping("/search")
    public ResponseEntity<?> getInquiriesByKeyword(@RequestParam(value = "keyword", required = false) String keyword) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        String username = authentication.getName(); // JWTì—ì„œ username ì¶”ì¶œ
        List<UserSupportSearchDTO> inquiries = supportService.getInquiriesByKeyword(username, keyword);
        if (inquiries.isEmpty()) {
            return ResponseEntity.ok("ê²€ìƒ‰ëœ ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
        }
        return ResponseEntity.ok(inquiries);
    }
    
    // ë¬¸ì˜ë‚´ì—­ ìƒì„¸ì¡°íšŒ(ì‚¬ìš©ì)
    @GetMapping("/{inquiryNo}")
    public ResponseEntity<?> getInquiryById(@PathVariable("inquiryNo") int inquiryNo) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }

        String username = authentication.getName(); // JWTì—ì„œ username ì¶”ì¶œ
        Optional<UserSupportDetailDTO> inquiry = supportService.getInquiryById(inquiryNo, username);

        if (inquiry.isPresent()) {
            return ResponseEntity.ok(inquiry.get());
        } else {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body("ë¬¸ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
	
	// ë¬¸ì˜ë‚´ì—­ ë‹µê¸€ ì‘ì„±(ì‘ì„±ì || ê´€ë¦¬ì)
	@PostMapping("/{inquiryNo}/reply")
	public ResponseEntity<?> addReply(
			@PathVariable("inquiryNo") int inquiryNo,
			@RequestBody Map<String, Object> requestBody) {
		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
		if (authentication == null || !authentication.isAuthenticated()) {
			return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
		}
		String username = authentication.getName(); // ë¡œê·¸ì¸ ìœ ì € ì•„ì´ë”” 
		boolean isAdmin = authentication.getAuthorities().stream() // ê´€ë¦¬ì ê¶Œí•œ
		        .anyMatch(authority -> authority.getAuthority().equals("ROLE_ADMIN"));
		
		String replyContent = (String) requestBody.get("reply"); // ì¶”ê°€í•  ë°ì´í„° ë©ì–´ë¦¬
		Object parentInquiryObj = requestBody.get("parentInquiry");
		
	    // inquiryNoì™€ parentInquiry ë¡œê·¸ ì¶”ê°€ (ë””ë²„ê¹… ìš©ë„)
	    System.out.println("ğŸ“Œ inquiryNo: " + inquiryNo);
	    System.out.println("ğŸ“Œ parentInquiry: " + parentInquiryObj);
		
	    // parentInquiry ê°’ì´ nullì´ ì•„ë‹Œ ê²½ìš° Integer ë³€í™˜
	    Integer parentInquiryId = null;
	    if (parentInquiryObj instanceof Number) {
	        parentInquiryId = ((Number) parentInquiryObj).intValue();  // ìˆ«ì íƒ€ì… ì²˜ë¦¬
	    } else if (parentInquiryObj instanceof String) {
	        try {
	            parentInquiryId = Integer.parseInt((String) parentInquiryObj);  // String â†’ Integer ë³€í™˜
	        } catch (NumberFormatException e) {
	            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("parentInquiry ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
	        }
	    }

	    if (replyContent == null || replyContent.trim().isEmpty()) {
	        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
	    }
	    
	    // inquiryNoê°€ 0ì´ê±°ë‚˜ parentInquiryIdê°€ 0ì´ë©´ ì˜ëª»ëœ ìš”ì²­ìœ¼ë¡œ ê°„ì£¼
	    if (inquiryNo <= 0) {
	        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ì˜¬ë°”ë¥´ì§€ ì•Šì€ inquiryNo ê°’ì…ë‹ˆë‹¤.");
	    }

	    Optional<SupportReplyWriteDTO> updatedInquiry = supportService.addReply(inquiryNo, username, isAdmin, replyContent, parentInquiryId);
	    if (updatedInquiry.isPresent()) {
	        return ResponseEntity.ok(updatedInquiry.get());
	    } else {
	        return ResponseEntity.status(HttpStatus.FORBIDDEN).body("ë‹µë³€ì„ ì‘ì„±í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
	    }
	}
	
	// ë¬¸ì˜ë‚´ì—­ ë‹µê¸€ ìˆ˜ì •(ì‘ì„±ì || ê´€ë¦¬ì)
	@PutMapping("/{replyNo}/edit")
	public ResponseEntity<?> editReply(
			@PathVariable("replyNo") int replyNo,
			@RequestBody Map<String, String> requestBody) {
		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
		if (authentication == null || !authentication.isAuthenticated()) {
			return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
		}
	    String username = authentication.getName();
	    
	    String newContent = requestBody.get("reply");
	    if (newContent == null || newContent.trim().isEmpty()) {
	        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
	    }
	    
	    Optional<SupportReplyUpdateDTO> updatedReply = supportService.editReply(replyNo, username, newContent);
	    if (updatedReply.isPresent()) {
	        return ResponseEntity.ok(updatedReply.get());
	    } else {
	        return ResponseEntity.status(HttpStatus.FORBIDDEN).body("ë‹µë³€ì„ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
	    }
	}
	
	// ë¬¸ì˜ë‚´ì—­ ë‹µê¸€ ì‚­ì œ(ì‘ì„±ì || ê´€ë¦¬ì)
	@DeleteMapping("/{replyNo}/delete")
	public ResponseEntity<?> deleteReply(@PathVariable("replyNo") int replyNo) {
	    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
	    if (authentication == null || !authentication.isAuthenticated()) {
	        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
	    }

	    String username = authentication.getName();
	    boolean deleted = supportService.deleteReply(replyNo, username);
	    if (deleted) {
	        return ResponseEntity.ok("ë‹µë³€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
	    } else {
	        return ResponseEntity.status(HttpStatus.FORBIDDEN).body("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
	    }
	}
	
	// ë¬¸ì˜ë‚´ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
	@PutMapping("/{inquiryNo}/complete")
	public ResponseEntity<?> completeInquiry(@PathVariable("inquiryNo") int inquiryNo) {
	    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
	    if (authentication == null || !authentication.isAuthenticated()) {
	        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
	    }
	    String username = authentication.getName();
	    boolean isAdmin = authentication.getAuthorities().stream()
	            .anyMatch(authority -> authority.getAuthority().equals("ROLE_ADMIN"));
		
	    boolean updated = supportService.completeInquiry(inquiryNo, username, isAdmin);
	    return updated ? ResponseEntity.ok("ë¬¸ì˜ê°€ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.") 
	    			   : ResponseEntity.status(HttpStatus.FORBIDDEN).body("ì²˜ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
	}
    
}
