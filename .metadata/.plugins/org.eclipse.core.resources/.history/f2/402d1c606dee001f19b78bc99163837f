package com.tecProject.tec.auth;

import java.io.IOException;
import java.util.Date;
import java.util.List;

import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.filter.OncePerRequestFilter;

import com.tecProject.tec.domain.User;
import com.tecProject.tec.dto.CustomUserDetails;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.ExpiredJwtException;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

public class JWTFilter extends OncePerRequestFilter{

	private final JWTUtil jwtUtil;
	private static final List<String> PUBLIC_API_ENDPOINTS = List.of(
			"/user/login", "/user/refresh", "/user/logout",
			"/api/code", "/api/ip/check", "/api/ip/validate"
	);
	
	public JWTFilter(JWTUtil jwtUtil) {
		this.jwtUtil = jwtUtil;
	}
	
	@Override
	protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
			throws ServletException, IOException {
		
		String requestURI = request.getRequestURI();
		// ë¹„íšŒì› í—ˆìš© APIëŠ” í•„í„° í†µê³¼
		if (PUBLIC_API_ENDPOINTS.contains(requestURI)) {
			filterChain.doFilter(request, response);
			return;
		}
		
		// requestì—ì„œ Authorization í—¤ë”ë¥¼ ì°¾ìŒ
		String authorization= request.getHeader("Authorization");
		// Authorization í—¤ë” ê²€ì¦
		if (authorization == null || !authorization.startsWith("Bearer ")) {
			response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
			response.getWriter().write("Unauthorized - No Access Token");
			return; // ì¡°ê±´ì´ í•´ë‹¹ë˜ë©´ ë©”ì†Œë“œ ì¢…ë£Œ (í•„ìˆ˜)
		}
		
		// Bearer ë¶€ë¶„ ì œê±° í›„ ìˆœìˆ˜ í† í°ë§Œ íšë“
		String token = authorization.replace("Bearer ", "");
	    Claims claims = null;
	    boolean isTokenExpired = false;
	    
	    try {
            claims = jwtUtil.parseToken(token);
	    } catch (ExpiredJwtException e) {
	        System.out.println("âš ï¸ Access Token ë§Œë£Œë¨, Refresh Token í™•ì¸ ì‹œì‘...");
	        isTokenExpired = true;
	        claims = jwtUtil.parseTokenWithoutExpirationCheck(token);
	    } catch (Exception e) {
	        System.out.println("ğŸš¨ JWT ê²€ì¦ ì‹¤íŒ¨: " + e.getMessage());
	        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
	        response.getWriter().write("Unauthorized - Invalid Access Token");
	        return;
	    }
	    
	    if (isTokenExpired) {
            String refreshToken = jwtUtil.getRefreshTokenFromCookie(request); // Refresh Token ê°€ì ¸ì˜¤ê¸°
            
            if (refreshToken == null || !jwtUtil.isRefreshTokenValid(refreshToken)) {
                System.out.println("Refresh Tokenì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ, 401 ë°˜í™˜");
                response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
                response.getWriter().write("Unauthorized - Invalid Refresh Token");
                return;
            }
                
            // ìƒˆ Token ë°œê¸‰
            String username = claims.get("username", String.class);
            String userType = claims.get("userType", String.class);
            String tokenFamily = claims.get("tokenFamily", String.class);

            String newAccessToken = jwtUtil.createAccessToken(username, userType, 1000L * 60 * 15);
            String newRefreshToken = jwtUtil.createRefreshToken(username, tokenFamily);
            
            jwtUtil.revokeRefreshToken(refreshToken); // ê¸°ì¡´ Refresh Token íê¸°
	            
            // ìƒˆë¡œìš´ Refresh Tokenì„ ì¿ í‚¤ì— ì €ì¥
            Cookie newRefreshCookie = new Cookie("refreshToken", newRefreshToken);
            newRefreshCookie.setHttpOnly(true);
            newRefreshCookie.setSecure(true);
            newRefreshCookie.setPath("/");
            response.addCookie(newRefreshCookie);
            
            response.setHeader("Authorization", "Bearer " + newAccessToken); // ìƒˆ Access Tokenì„ ì‘ë‹µ í—¤ë”ì— ì¶”ê°€
            System.out.println("ìƒˆë¡œìš´ Access Token ë°œê¸‰ ì™„ë£Œ!");
        }
		
		// í† í°ì—ì„œ usernameê³¼ userType íšë“
        String username = claims.get("username", String.class); // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        String userType = claims.get("userType", String.class); // ì‚¬ìš©ì ì—­í•  ê°€ì ¸ì˜¤ê¸°
			
		// userë¥¼ ìƒì„±í•˜ì—¬ ê°’ set
		User user = new User();
		user.setUsername(username);
		user.setPassword("temppassword");// ë§¤ë²ˆ db ì¡°íšŒí•  í•„ìš” ì—†ê²Œ ì„ì˜ê°’ ë„£ì–´ë‘ 
		user.setUserType(userType);
			
		//UserDetailsì— íšŒì› ì •ë³´ ê°ì²´ ë‹´ê¸°
		CustomUserDetails customUserDetails = new CustomUserDetails(user);
		
		//ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì¸ì¦ í† í° ìƒì„±
		Authentication authToken = new UsernamePasswordAuthenticationToken(customUserDetails, null, customUserDetails.getAuthorities());
		
		//ì„¸ì…˜ì— ì‚¬ìš©ì ë“±ë¡
		SecurityContextHolder.getContext().setAuthentication(authToken);
		
 		filterChain.doFilter(request, response);
	}
	


	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
}