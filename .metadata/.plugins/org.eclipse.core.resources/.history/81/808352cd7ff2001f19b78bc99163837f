package com.tecProject.tec.service;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.tecProject.tec.domain.UserSupport;
import com.tecProject.tec.domain.UserSupport.InquiryCategory;
import com.tecProject.tec.domain.UserSupport.InquiryStatus;
import com.tecProject.tec.dto.support.AdminSupportDetailDTO;
import com.tecProject.tec.repository.SupportRepository;

@Service
public class AdminSupportService {
	private final SupportRepository supportRepository;
	
	public AdminSupportService(SupportRepository supportRepository) {
		this.supportRepository = supportRepository;
	}
	
    // ë¬¸ì˜ë‚´ì—­ ì „ì²´ì¡°íšŒ(ê´€ë¦¬ì)
	public Page<UserSupport> getFilteredInquiries(Pageable pageable, InquiryStatus status, InquiryCategory category, String keyword) {
	    if (status != null && category != null && keyword != null) { // ë¬¸ì˜ìƒíƒœ + ì¹´í…Œê³ ë¦¬ + í‚¤ì›Œë“œ ì¡°íšŒ
	        return supportRepository.findByStatusAndCategoryAndTitleContainingAndIsDeletedAndParentInquiryIsNull(status, category, keyword, "N", pageable);
	    } else if (status != null && category != null) { // ë¬¸ì˜ìƒíƒœ + ì¹´í…Œê³ ë¦¬
	    	return supportRepository.findByStatusAndCategoryAndIsDeletedAndParentInquiryIsNull(status, category, "N", pageable);
	    } else if (status != null && keyword != null) { // ë¬¸ì˜ìƒíƒœ + í‚¤ì›Œë“œ
	    	return supportRepository.findByStatusAndTitleContainingAndIsDeletedAndParentInquiryIsNull(status, keyword, "N", pageable);
	    } else if (category != null && keyword != null) { // ì¹´í…Œê³ ë¦¬ + í‚¤ì›Œë“œ
	    	return supportRepository.findByCategoryAndTitleContainingAndIsDeletedAndParentInquiryIsNull(category, keyword, "N", pageable);
	    } else if (status != null) { // ë¬¸ì˜ìƒíƒœ ì¡°íšŒ
	        return supportRepository.findByStatusAndIsDeletedAndParentInquiryIsNull(status, "N", pageable);
	    } else if (category != null) { // ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
	        return supportRepository.findByCategoryAndIsDeletedAndParentInquiryIsNull(category, "N", pageable);
	    } else if (keyword != null) { // í‚¤ì›Œë“œ ì¡°íšŒ
	        return supportRepository.findByTitleContainingAndIsDeletedAndParentInquiryIsNull(keyword, "N", pageable);
	    } // ê¸°ë³¸ ì „ì²´ ì¡°íšŒ
	    return supportRepository.findByIsDeletedAndParentInquiryIsNull("N", pageable); 
	}

	// ë¬¸ì˜ë‚´ì—­ ìƒì„¸ì¡°íšŒ(ê´€ë¦¬ì)
	@Transactional
	public Optional<AdminSupportDetailDTO> getInquiryById(int inquiryNo) { 
        Optional<UserSupport> inquiry = supportRepository.findById(inquiryNo);
        if (inquiry.isEmpty() || "Y".equals(inquiry.get().getIsDeleted())) {
            return Optional.empty();
        } 
        
        UserSupport inquiryEntity = inquiry.get(); // ğŸ”¹ Optional â†’ ì‹¤ì œ ê°ì²´ ë³€í™˜

        // âœ… ëª¨ë“  ë‹µë³€ ì¡°íšŒ (ìµœìƒìœ„ ë‹µë³€ + í•˜ìœ„ ë‹µë³€ í¬í•¨)
        List<UserSupport> allReplies = supportRepository.findByInquiryNoOrParentInquiry(inquiryNo);

        // âœ… ë‹µë³€ì„ ë§µì— ì €ì¥ (inquiryNo â†’ DTO ë³€í™˜ í›„ ì €ì¥)
        Map<Integer, AdminSupportDetailDTO> replyMap = new HashMap<>();
        for (UserSupport reply : allReplies) {
            AdminSupportDetailDTO replyDTO = AdminSupportDetailDTO.fromEntity(reply);
            replyDTO.setReplies(new ArrayList<>());
            replyMap.put(reply.getInquiryNo(), replyDTO);
        }

        // âœ… ë¶€ëª¨-ìì‹ ê´€ê³„ ë§¤í•‘
        List<AdminSupportDetailDTO> structuredReplies = new ArrayList<>();
        for (AdminSupportDetailDTO replyDTO : replyMap.values()) {
            if (replyDTO.getParentInquiry() != null && replyDTO.getParentInquiry().equals(inquiryNo)) {
                structuredReplies.add(replyDTO); // ìµœìƒìœ„ ë¶€ëª¨ ë‹µë³€
            } else {
                AdminSupportDetailDTO parentReply = replyMap.get(replyDTO.getParentInquiry());
                if (parentReply != null) {
                    parentReply.getReplies().add(replyDTO);
                }
            }
        }

        // âœ… DTO ë³€í™˜ (ìµœìƒìœ„ ë¶€ëª¨ ë‹µë³€ í¬í•¨)
        AdminSupportDetailDTO inquiryDTO = AdminSupportDetailDTO.fromEntity(inquiryEntity);
        inquiryDTO.setReplies(structuredReplies);

        System.out.println("âœ… ë°±ì—”ë“œ ì‘ë‹µ ë°ì´í„°: " + inquiryDTO);
        return Optional.of(inquiryDTO);
    }
}
